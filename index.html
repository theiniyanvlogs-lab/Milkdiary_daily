<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Milk Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, set } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHQqBRiM6RRAE7CCfbp2spxXUt65QxGPs",
  authDomain: "milkdiarylock.firebaseapp.com",
  databaseURL: "https://milkdiarylock-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "milkdiarylock",
  storageBucket: "milkdiarylock.firebasestorage.app",
  messagingSenderId: "602886268250",
  appId: "1:602886268250:web:b8010e9df56b3164c9bf63"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Generate or load device ID
function getDeviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = "DEV-" + Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", id);
  }
  return id;
}

// Unlock function
window.unlockApp = function(){

  const custId = document.getElementById("custId").value.trim();
  const pwd = document.getElementById("unlockPwd").value.trim();
  const devId = getDeviceId();

  if(custId=="" || pwd==""){
    alert("Enter Customer ID & Password");
    return;
  }

  const baseRef = ref(db, "customers/" + custId);

  get(baseRef).then((snap)=>{
    if(!snap.exists()){
      alert("Customer not found");
      return;
    }

    const data = snap.val();

    // Password check
    if(data.password !== pwd){
      alert("‚ùå Wrong Password");
      return;
    }

    // Device Lock Check
    if(data.deviceId === ""){
        set(ref(db,"customers/"+custId+"/deviceId"), devId);
    }
    else if(data.deviceId !== devId){
        alert("‚ùå This account already used on another phone");
        return;
    }

    // Load Bill
    loadBill(data.bill);

    document.getElementById("lockScreen").style.display="none";
    document.getElementById("mainApp").style.display="block";
  });
}

// Build Detailed Bill Format
function loadBill(b){

  const dailyTotal = b.dailyPkt * b.days;
  const finalMilk = dailyTotal + b.extraPkt - b.notSuppliedPkt;
  const milkAmount = finalMilk * b.milkRate;
  const grandTotal = milkAmount + b.serviceCharge;

  const billText = `
MILK DIARY BILL

Plot / Door No:
${b.doorNo}

Address:
${b.address}

Period:
${b.periodFrom}  to  ${b.periodTo}

--------------------------------

Daily Milk:
${b.dailyPkt} pkt √ó ${b.days} days = ${dailyTotal} pkt

Extra Milk:
${b.extraPkt == 0 ? "Nil" : b.extraPkt + " pkt"}
Total Extra: ${b.extraPkt} pkt

Not Supplied:
${b.notSuppliedDate} : ${b.notSuppliedPkt} pkt

Total Not Supplied: ${b.notSuppliedPkt} pkt

--------------------------------

Final Milk:
${dailyTotal} + ${b.extraPkt} - ${b.notSuppliedPkt} = ${finalMilk} pkt

Milk Rate:
‚Çπ${b.milkRate} per pkt

Milk Amount:
${finalMilk} √ó ‚Çπ${b.milkRate} = ‚Çπ${milkAmount}

Service Charge:
‚Çπ${b.serviceCharge}

--------------------------------

GRAND TOTAL:
‚Çπ${grandTotal}

--------------------------------
Powered by Milk Diary - iniyan.talkies
`;

document.getElementById("billText").innerText = billText;
}
</script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
.center{display:flex;align-items:center;justify-content:center;height:100vh}
.box{background:#fff;padding:25px;border-radius:10px;max-width:420px;width:100%;text-align:center;box-shadow:0 0 10px #ccc}
input{width:100%;padding:10px;margin-top:10px;font-size:16px}
button{padding:12px;border:none;border-radius:6px;margin-top:10px;width:100%;font-size:16px}
.blue{background:#2196f3;color:#fff}
.green{background:#4caf50;color:#fff}
.gray{background:#999;color:#fff}
.billBox{background:#fff;padding:20px;border-radius:10px;max-width:520px;margin:auto;box-shadow:0 0 10px #ccc}
pre{white-space:pre-wrap;font-size:15px}
header{background:#1976d2;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:bold}
</style>
</head>

<body>

<!-- LOCK SCREEN -->
<div id="lockScreen" class="center">
  <div class="box">
    <h3>üîí Milk Diary Login</h3>
    <input id="custId" placeholder="Customer ID (ex: CUST001)">
    <input id="unlockPwd" type="password" placeholder="Password">
    <button class="blue" onclick="unlockApp()">Unlock</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">

<header>MILK DIARY - BILL</header>
<br>

<div class="billBox" id="billContent">
<pre id="billText"></pre>

<button class="green" onclick="sendWhatsApp()">üì≤ Send to WhatsApp</button>
<button class="gray" onclick="location.reload()">‚¨Ö Logout</button>

</div>
</div>

<!-- WhatsApp -->
<script>
function sendWhatsApp(){
  let text = document.getElementById("billText").innerText;
  window.open("https://wa.me/?text=" + encodeURIComponent(text));
}
</script>

</body>
</html>
